{% extends "layouts/base.html" %}

{% block title %}Authorize agent wallet ‚Äî Nonchalant Bot{% endblock %}

{% block content %}
  <section class="agent-hero ui-card ui-card--surface">
    <div class="agent-hero__body">
      <div class="agent-hero__eyebrow">Agent authorization</div>
      <h1 class="agent-hero__title">Delegate trading to a secure Hyperliquid agent</h1>
      <p class="agent-hero__copy">
        Create an API wallet on Hyperliquid, keep custody of your funds, and let Nonchalant Bot execute the
        plan for you. Every step is guided, encrypted, and tracked so you stay in control.
      </p>
      <div class="agent-hero__cta">
        <a class="ui-button ui-button--primary" href="{{ agent_deep_link }}" target="_blank" rel="noopener">
          Open Hyperliquid API portal
        </a>
        <p class="agent-hero__caption">
          Deep link opens <code>app.hyperliquid.xyz/API</code> in a new tab so you can create or manage API wallets.
        </p>
      </div>
    </div>
    <div class="agent-hero__illust" aria-hidden="true">
      <div class="agent-orb"></div>
      <div class="agent-orb agent-orb--secondary"></div>
    </div>
  </section>

  <section class="agent-steps" aria-labelledby="agent-steps-heading">
    <article class="ui-card ui-card--surface agent-steps__card">
      <header class="ui-card__header">
        <div class="ui-card__header-left">
          <h2 id="agent-steps-heading" class="ui-card__title">Authorize in three moves</h2>
        </div>
        <span class="ui-card__header-right">Checklist</span>
      </header>
      <ol class="agent-steps__list">
        <li class="agent-step">
          <div class="agent-step__header">
            <span class="agent-step__title">Create agent wallet</span>
            <span class="agent-step__meta">Step 1</span>
          </div>
          <p>
            In Hyperliquid‚Äôs API portal choose <em>Create API wallet</em>. Approve with your primary wallet and save the
            generated agent address and private key offline.
          </p>
        </li>
        <li class="agent-step">
          <div class="agent-step__header">
            <span class="agent-step__title">Authorize trading scope</span>
            <span class="agent-step__meta">Step 2</span>
          </div>
          <p>
            Review the capabilities shown in Hyperliquid. Agents can place trades and move funds internally but never
            withdraw on L1. Confirm once the scope matches your plan.
          </p>
        </li>
        <li class="agent-step">
          <div class="agent-step__header">
            <span class="agent-step__title">Register in Nonchalant Bot</span>
            <span class="agent-step__meta">Step 3</span>
          </div>
          <p>
            Return here and submit the agent details. We encrypt credentials immediately and log a signed audit event for
            every registration.
          </p>
        </li>
      </ol>
    </article>
  </section>

  <section class="agent-form-card ui-card ui-card--surface" aria-labelledby="agent-form-heading">
    <header class="ui-card__header">
      <div class="ui-card__header-left">
        <span class="ui-card__kicker">Secure storage</span>
        <h2 id="agent-form-heading" class="ui-card__title">Register agent credentials</h2>
      </div>
      <span class="ui-card__header-right">Encrypted at rest</span>
    </header>
    <p class="agent-form-card__lead">
      Provide a label, agent wallet address, and the private key generated by Hyperliquid. We encrypt the payload instantly
      and never surface the key again.
    </p>

    <form
      class="agent-form"
      hx-post="/authz/agent"
      hx-target="#agent-form-status"
      hx-swap="innerHTML"
      hx-headers='{"X-Requested-With": "HTMX"}'
    >
      <div class="agent-form__grid">
        <label class="ui-field">
          <span class="ui-field__label">Label</span>
          <input name="label" type="text" placeholder="Primary bot" required maxlength="64" />
          <small class="ui-field__hint">Example: ‚ÄúMomentum Bot ¬∑ Testnet‚Äù.</small>
        </label>
        <label class="ui-field">
          <span class="ui-field__label">Agent address</span>
          <input name="agent_address" type="text" placeholder="0x..." required pattern="0x[a-fA-F0-9]{40}" />
          <small class="ui-field__hint">Paste the 0x-prefixed agent wallet address issued by Hyperliquid.</small>
        </label>
        <label class="ui-field ui-field--full">
          <span class="ui-field__label">Private key</span>
          <input name="private_key" type="password" placeholder="0x..." required pattern="0x[a-fA-F0-9]{64}" />
          <small class="ui-field__hint">Stored encrypted. The key is never shown again after submission.</small>
        </label>
      </div>
      <div class="agent-form__actions">
        <button class="ui-button ui-button--primary" type="submit">Register agent</button>
        <button class="ui-button" type="reset">Clear form</button>
        <div id="agent-form-status" class="agent-form__status" role="status" aria-live="polite"></div>
      </div>
    </form>

    <aside class="agent-alert">
      <div class="agent-alert__icon" aria-hidden="true">üîí</div>
      <div class="agent-alert__body">
        <h3 class="agent-alert__title">Security notes</h3>
        <ul class="agent-alert__list">
          <li>Only use API wallets created on Hyperliquid‚Äînever paste a primary wallet key.</li>
          <li>Agent keys stay encrypted at rest with server-managed secrets and can be rotated any time.</li>
          <li>Rotate agents between runs to avoid nonce collisions and keep audit trails tight.</li>
        </ul>
      </div>
    </aside>
  </section>

  <div
    id="agent-vault"
    hx-get="/authz/agent/list"
    hx-trigger="load, agent:refresh from:body"
    hx-target="#agent-vault"
    hx-swap="innerHTML"
  >
    {% include "authz/_agent_list.html" with context %}
  </div>
{% endblock %}
